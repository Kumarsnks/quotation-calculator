<!DOCTYPE html>
<html>
<head>
    <title>Quotation Calculator</title>
    <meta charset="UTF-8">
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        h2 {
            margin-bottom: 10px;
        }

        table {
            border-collapse: collapse;
            width: 100%;
            font-size: 13px;
        }

        th, td {
            border: 1px solid #ccc;
            padding: 6px;
            text-align: center;
            white-space: nowrap;
        }

        th {
            background-color: #f4f4f4;
        }

        input, select {
            width: 90px;
            padding: 3px;
        }

        .readonly {
            background-color: #f9f9f9;
            font-weight: bold;
        }

        .icon {
            cursor: pointer;
            font-size: 18px;
        }

        .footer {
            margin-top: 10px;
            font-weight: bold;
            text-align: right;
        }
    </style>
</head>
<body>

<h2>Quotation Calculator</h2>

<table id="quoteTable">
<thead>
<tr>
    <th>Role</th>
    <th>Count</th>
    <th>Compensation</th>
    <th>Emp Cost</th>
    <th>Overhead (Hr)</th>
    <th>Margin %</th>
    <th>Hours</th>
    <th>Total Hrs</th>
    <th>Internal Cost</th>
    <th>Cost + OH</th>
    <th>Final Amount</th>
    <th>➕</th>
</tr>
</thead>

<tbody>
</tbody>
</table>

<div class="footer">
    Grand Total: <span id="grandTotal">0</span>
</div>

<script>
let roles = {{ roles | tojson }};
let roleRates = {};

fetch("/roles")
    .then(res => res.json())
    .then(data => roleRates = data);

// ---------------- ROW HANDLING ----------------
function addRow() {
    let tbody = document.querySelector("#quoteTable tbody");

    let tr = document.createElement("tr");
    tr.innerHTML = `
        <td>
            <select class="role" onchange="populateRoleFields(this)">
                ${roles.map(r => `<option value="${r}">${r}</option>`).join("")}
            </select>
        </td>
        <td><input type="number" class="count" value="1" min="0"></td>
        <td class="comp readonly"></td>
        <td class="emp readonly"></td>
        <td class="overhead readonly"></td>
        <td><input type="number" class="margin" value="30" min="0"></td>
        <td><input type="number" class="hours" value="200" min="0"></td>
        <td class="total_hours readonly"></td>
        <td class="internal readonly"></td>
        <td class="cost_overhead readonly"></td>
        <td class="final readonly"></td>
        <td class="icon" onclick="removeRow(this)">❌</td>
    `;
    tbody.appendChild(tr);

    populateRoleFields(tr.querySelector(".role"));
}

function removeRow(el) {
    el.closest("tr").remove();
    calculateGrandTotal();
}

// ---------------- AUTO POPULATE ----------------
function populateRoleFields(selectEl) {
    let tr = selectEl.closest("tr");
    let role = selectEl.value;

    if (!roleRates[role]) return;

    tr.querySelector(".comp").innerText = roleRates[role].compensation;
    tr.querySelector(".emp").innerText = roleRates[role].emp_cost;
    tr.querySelector(".overhead").innerText = roleRates[role].overhead_hourly;

    calculateRow(tr);
}

// ---------------- CALCULATIONS ----------------
function calculateRow(tr) {
    fetch("/calculate", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            role: tr.querySelector(".role").value,
            count: tr.querySelector(".count").value,
            hours: tr.querySelector(".hours").value,
            margin: tr.querySelector(".margin").value
        })
    })
    .then(res => res.json())
    .then(d => {
        tr.querySelector(".total_hours").innerText = d.total_hours;
        tr.querySelector(".internal").innerText = d.internal_cost;
        tr.querySelector(".cost_overhead").innerText = d.cost_with_overhead;
        tr.querySelector(".final").innerText = d.final_amount;
        calculateGrandTotal();
    });
}

// ---------------- EVENTS ----------------
document.addEventListener("input", function(e) {
    let tr = e.target.closest("tr");
    if (tr && (e.target.classList.contains("count")
        || e.target.classList.contains("hours")
        || e.target.classList.contains("margin"))) {
        calculateRow(tr);
    }
});

// ---------------- GRAND TOTAL ----------------
function calculateGrandTotal() {
    let total = 0;
    document.querySelectorAll(".final").forEach(el => {
        total += Number(el.innerText || 0);
    });
    document.getElementById("grandTotal").innerText = total.toFixed(2);
}

// Initialize with one row
addRow();
</script>

</body>
</html>
